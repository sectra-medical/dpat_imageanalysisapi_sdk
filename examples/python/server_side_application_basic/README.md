Server-side applications demo
========

## About
This is a demo repository showing examples of simple Sectra server-side applications using a Flask server.

Authors: Nicolas Brandt nicolas.brandt@hcuge.ch, Laura Padayachy laura.padayachy@hug.ch, Mario Kreutzfeldt Mario.Kreutzfeldt@hcuge.ch

## Application 1: generate_tokens_server.py

An application that allows the user to right click and save in an excel file the callback url, slide id and a token. These can then be used to interact via API with the slide.

- Input:
- Output: a new line is added to the "tokens" excel file, with entry: slide name (from the LIS), slide id, callback url, token

## Application 2: launch_analysis_server.py

An application that allows the user to call a predefined python script, for example an analysis script to run on the current slide.

- Input: 
- Output: the output generated by the python script

## Application 3: send_annotations_server.py

An application that allows the user to define a region and a tag and have the coordinates and the tag of the annotations saved, as well as the annotation sent back for display and the slide downloaded.
This allows for annotation collection within Sectra, as opposed to default sectra annotations which can only be downloaded manually.

- Input: User draws a polygon around a region of interest and associates a tag
- Output: a graphical primitive corresponding to the drawn region; slide name, slide id sectra coordinates, unnormalized coordinates and tag entry are saved in an excel sheet; the slide is downloaded if not present


### Install and run

Requirements for running the three aplications can be installed using:

```
pip install -r requirements.txt
```

In each script, the IP used must be specified and default port 5000 is assumed. The application id to use for send_annotation_server.py is specified within the Sectra server configuration (see below).

Applications can then be launched using:

```
python <python_script>.py
```


## Sectra Server configuration

Running the application starts a web server on the specified IP listening on Flask default port of 5000.

You need to configure the Sectra Pathology Server (SPS) to call this server. This involves:

1. Ensuring that the SPS can reach this host over the network (ensure there is a route and that firewall rules allow it)
2. Registering the app in the configuration interface (see chapter 7 in the System Administrator Manual)
  - in brief: goto https://<pathologyserver>/sectrapathologyimport/config
  - log in, click Image Analysis Applications
  - Under Server Side Applications, click 'register new'
  - Enter the URL where your started web server is running, as reachable from the pathology server. Example: `http://<IP>:5000/Get_token` for generate_tokens_server.py
  - Specify the application id, display name and manufacturer
  - For input template, use "{"type":"wholeSlide"}" for generate_tokens_server.py and launch_analysis_server.py and "{"type":"taggedPolygon","content":{"tags":["Tag1","Tag2"]}}" for send_annotations_server.py
  - Alternatively, these can be autopopulated using the retrieve registration info button if the server is running
  - press *Save*
  - Per default, the app is disabled. Click the 'disabled' button to toggle it to enabled.

If succesful, you should now be able to right-click in any Pathology Image and select the new registered server-side application (you might need to refresh any running sessions).


## Tested with

- DPAT 3.2 on 2024-03-06
