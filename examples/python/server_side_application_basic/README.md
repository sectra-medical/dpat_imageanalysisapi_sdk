Server-side applications demo
========

## About
This is a demo repository showing examples of simple Sectra server-side applications using a Flask server.

Authors: Nicolas Brandt nicolas.brandt@hcuge.ch, Laura Padayachy laura.padayachy@hug.ch, Mario Kreutzfeldt Mario.Kreutzfeldt@hcuge.ch

## Application 1: generate_tokens_server.py

An application that allows the user to right click and save in an excel file the callback url, slide id and a token. These can then be used to interact via API with the slide.

- Input:
- Output: a new line is added to the "tokens" excel file, with entry: slide name (from the LIS), slide id, callback url, token

## Application 2: launch_analysis_server.py

An application that allows the user to call a predefined python script, for example an analysis script to run on the current slide.

- Input: 
- Output: the output generated by the python script

## Application 3: send_annotations_server.py

An application that allows the user to define a region and a tag and have the coordinates and the tag of the annotations saved, as well as the annotation sent back for display and the slide downloaded.
This allows for annotation collection within Sectra, as opposed to default sectra annotations which can only be downloaded manually.

- Input: User draws a polygon around a region of interest and associates a tag
- Output: a graphical primitive corresponding to the drawn region; slide name, slide id sectra coordinates, unnormalized coordinates and tag entry are saved in an excel sheet; the slide is downloaded if not present

## Application 4: feedback_server.py

An application that displays precomputed results in the Sectra viewer using the patchCollection type result and allows the user to send feedback on correctly or incorrectly classified patches. The gallery view can be a more convenient way to visualize patch-based outputs than primitive annotations and allows for interaction with the user.

This example expects two prediction labels (positive and negative) and two feedback categories (positive (feedback) and negative (feedback)). The user can within the viewer drag the patch to the appropriate category or select the new category at the center of the viewer when selecting a patch.

Precomputed results for a slide are expected to be saved as a csv file, where rows are: the slide name ("lisSlideId" from Sectra metadata), the path to the associated patch image, the x coordinate of the center of the patch in Sectra coordinates, the y coordinate of the center of the patch in Sectra coordinates, the sort_key for ordering patches, the prediction label, and the tag (category where the patch will be displayed in Sectra). Additionally, the patch images are saved.

Once the user has changed the patch category for feedback, the user can click on “Send feedback results”. This will generate four folders (TP,FP,FN,TN) correspond to true positives, false positives, false negatives, true negatives; saved results patches will then be copied to the appropriate folder, using the new tag associated to the patch sent for feedback. The user can send feedback multiple times, as the older folders are removed and recreated.

The “feedback” folder in the repo shows an example of the output folder structure and precomputed results csv file for a slide.


- Input: 
- Output: gallery view display of precomputed results

### Install and run

Requirements for running the three aplications can be installed using:

```
pip install -r requirements.txt
```

In each script, the IP used must be specified and default port 5000 is assumed. The application id to use for send_annotation_server.py is specified within the Sectra server configuration (see below).

Applications can then be launched using:

```
python <python_script>.py
```


## Sectra Server configuration

Running the application starts a web server on the specified IP listening on Flask default port of 5000.

You need to configure the Sectra Pathology Server (SPS) to call this server. This involves:

1. Ensuring that the SPS can reach this host over the network (ensure there is a route and that firewall rules allow it)
2. Registering the app in the configuration interface (see chapter 7 in the System Administrator Manual)
  - in brief: goto https://<pathologyserver>/sectrapathologyimport/config
  - log in, click Image Analysis Applications
  - Under Server Side Applications, click 'register new'
  - Enter the URL where your started web server is running, as reachable from the pathology server. Example: `http://<IP>:5000/Get_token` for generate_tokens_server.py
  - Specify the application id, display name and manufacturer
  - For input template, use "{"type":"wholeSlide"}" for generate_tokens_server.py and launch_analysis_server.py and "{"type":"taggedPolygon","content":{"tags":["Tag1","Tag2"]}}" (i.e. the desired tags) for send_annotations_server.py
  - Alternatively, these can be autopopulated using the retrieve registration info button if the server is running
  - press *Save*
  - Per default, the app is disabled. Click the 'disabled' button to toggle it to enabled.

If succesful, you should now be able to right-click in any Pathology Image and select the new registered server-side application (you might need to refresh any running sessions).


## Tested with

- DPAT 3.2 on 2024-03-06
